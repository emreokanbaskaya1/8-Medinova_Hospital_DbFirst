@{
    ViewBag.Title = "Book Appointment";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="main-content">
    <div class="page-header">
        <div class="row align-items-center">
            <div class="col-sm-6">
                <h3 class="page-title">Create New Appointment</h3>
                <ul class="breadcrumb">
                    <li class="breadcrumb-item"><a href="@Url.Action("Index")">Patient Panel</a></li>
                    <li class="breadcrumb-item active">Book Appointment</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="feather-calendar me-2"></i>Appointment Details
                    </h5>
                </div>
                <div class="card-body">
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show">
                            <i class="feather-alert-circle me-2"></i>@TempData["Error"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    @using (Html.BeginForm("CreateAppointment", "Patient", new { area = "Patient" }, FormMethod.Post, new { @class = "needs-validation", novalidate = "novalidate" }))
                    {
                        @Html.AntiForgeryToken()

                        <div class="row">
                            <!-- Department Selection -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Department <span class="text-danger">*</span></label>
                                @Html.DropDownList("departmentId", ViewBag.Departments as SelectList, "Select Department", new { @class = "form-select", @id = "departmentSelect", required = "required" })
                                <div class="invalid-feedback">Please select a department.</div>
                            </div>

                            <!-- Doctor Selection -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Doctor <span class="text-danger">*</span></label>
                                <select name="doctorId" id="doctorSelect" class="form-select" required disabled>
                                    <option value="">Select Department First</option>
                                </select>
                                <div class="invalid-feedback">Please select a doctor.</div>
                            </div>

                            <!-- Date Selection -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Date <span class="text-danger">*</span></label>
                                @Html.DropDownList("appointmentDate", ViewBag.DateList as List<SelectListItem>, "Select Date", new { @class = "form-select", @id = "dateSelect", required = "required", disabled = "disabled" })
                                <div class="invalid-feedback">Please select a date.</div>
                            </div>

                            <!-- Time Selection -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Time <span class="text-danger">*</span></label>
                                <select name="appointmentTime" id="timeSelect" class="form-select" required disabled>
                                    <option value="">Select Date First</option>
                                </select>
                                <div class="invalid-feedback">Please select a time.</div>
                            </div>
                        </div>

                        <!-- Available Hours Visual -->
                        <div id="availableHoursContainer" class="mb-4" style="display: none;">
                            <label class="form-label fw-bold">Available Time Slots</label>
                            <div id="hoursGrid" class="d-flex flex-wrap gap-2">
                                <!-- Hours will be loaded dynamically -->
                            </div>
                        </div>

                        <hr />

                        <div class="d-flex justify-content-between">
                            <a href="@Url.Action("Index")" class="btn btn-secondary">
                                <i class="feather-arrow-left me-1"></i> Go Back
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                                <i class="feather-check me-1"></i> Create Appointment
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function() {
            // When department changes
            $('#departmentSelect').change(function() {
                var departmentId = $(this).val();
                
                if (departmentId) {
                    $.ajax({
                        url: '@Url.Action("GetDoctorsByDepartment", "Patient", new { area = "Patient" })',
                        type: 'GET',
                        data: { departmentId: departmentId },
                        success: function(data) {
                            var options = '<option value="">Select Doctor</option>';
                            $.each(data, function(i, item) {
                                options += '<option value="' + item.Value + '">' + item.Text + '</option>';
                            });
                            $('#doctorSelect').html(options).prop('disabled', false);
                            $('#dateSelect').prop('disabled', true).val('');
                            $('#timeSelect').prop('disabled', true).html('<option value="">Select Date First</option>');
                            $('#availableHoursContainer').hide();
                            $('#submitBtn').prop('disabled', true);
                        }
                    });
                } else {
                    $('#doctorSelect').prop('disabled', true).html('<option value="">Select Department First</option>');
                }
            });

            // When doctor changes
            $('#doctorSelect').change(function() {
                var doctorId = $(this).val();
                
                if (doctorId) {
                    $('#dateSelect').prop('disabled', false);
                } else {
                    $('#dateSelect').prop('disabled', true).val('');
                    $('#timeSelect').prop('disabled', true);
                }
                $('#timeSelect').html('<option value="">Select Date First</option>');
                $('#availableHoursContainer').hide();
                $('#submitBtn').prop('disabled', true);
            });

            // When date changes
            $('#dateSelect').change(function() {
                var doctorId = $('#doctorSelect').val();
                var selectedDate = $(this).val();
                
                if (doctorId && selectedDate) {
                    $.ajax({
                        url: '@Url.Action("GetAvailableHours", "Patient", new { area = "Patient" })',
                        type: 'POST',
                        data: { doctorId: doctorId, selectedDate: selectedDate },
                        success: function(data) {
                            var options = '<option value="">Select Time</option>';
                            var hoursHtml = '';
                            
                            $.each(data, function(i, item) {
                                if (!item.IsBooked) {
                                    options += '<option value="' + item.Time + '">' + item.Time + '</option>';
                                    hoursHtml += '<span class="badge bg-success p-2 hour-badge" style="cursor: pointer;" data-time="' + item.Time + '">' + item.Time + '</span>';
                                } else {
                                    hoursHtml += '<span class="badge bg-danger p-2" style="text-decoration: line-through;">' + item.Time + ' (Booked)</span>';
                                }
                            });
                            
                            $('#timeSelect').html(options).prop('disabled', false);
                            $('#hoursGrid').html(hoursHtml);
                            $('#availableHoursContainer').show();
                            
                            // Click on hour badges
                            $('.hour-badge').click(function() {
                                var time = $(this).data('time');
                                $('#timeSelect').val(time);
                                $('.hour-badge').removeClass('bg-primary').addClass('bg-success');
                                $(this).removeClass('bg-success').addClass('bg-primary');
                                checkFormValidity();
                            });
                        }
                    });
                }
            });

            // When time changes
            $('#timeSelect').change(function() {
                checkFormValidity();
                var selectedTime = $(this).val();
                $('.hour-badge').removeClass('bg-primary').addClass('bg-success');
                $('.hour-badge[data-time="' + selectedTime + '"]').removeClass('bg-success').addClass('bg-primary');
            });

            function checkFormValidity() {
                var isValid = $('#departmentSelect').val() && 
                              $('#doctorSelect').val() && 
                              $('#dateSelect').val() && 
                              $('#timeSelect').val();
                $('#submitBtn').prop('disabled', !isValid);
            }
        });
    </script>
}
