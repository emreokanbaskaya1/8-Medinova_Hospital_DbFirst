@model IEnumerable<Medinova.Models.User>
@{
    ViewBag.Title = "User Management";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col-12">
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show">
                <i class="feather-check-circle me-2"></i>@TempData["Success"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show">
                <i class="feather-alert-circle me-2"></i>@TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="feather-users me-2"></i>All Users
                </h5>
                <span class="badge bg-primary fs-12">@Model.Count() Users</span>
            </div>
            <div class="card-body">
                @if (Model != null && Model.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover" id="usersTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Full Name</th>
                                    <th>Username</th>
                                    <th>Current Role</th>
                                    <th>Doctor Profile</th>
                                    <th>Quick Assign</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var user in Model)
                                {
                                    var currentRole = user.Roles.FirstOrDefault()?.RoleName ?? "No Role";
                                    var roleClass = currentRole == "Admin" ? "bg-danger" :
                                                   currentRole == "Doctor" ? "bg-primary" :
                                                   currentRole == "Patient" ? "bg-success" : "bg-secondary";
                                    
                                    <tr>
                                        <td>@user.UserId</td>
                                        <td>
                                            <strong>@user.FirstName @user.LastName</strong>
                                        </td>
                                        <td>
                                            <code>@user.UserName</code>
                                        </td>
                                        <td>
                                            <span class="badge @roleClass">@currentRole</span>
                                        </td>
                                        <td>
                                            @if (user.Doctor != null)
                                            {
                                                <span class="badge bg-info" title="@user.Doctor.FullName">
                                                    <i class="feather-user-check me-1"></i>@user.Doctor.FullName
                                                </span>
                                            }
                                            else if (currentRole == "Doctor")
                                            {
                                                <span class="badge bg-warning text-dark">
                                                    <i class="feather-alert-triangle me-1"></i>Not Assigned
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            <select class="form-select form-select-sm" style="width: 130px;" 
                                                    onchange="quickAssignRole(@user.UserId, this.value)"
                                                    id="roleSelect_@user.UserId">
                                                <option value="">-- Select --</option>
                                                <option value="1" @(currentRole == "Admin" ? "selected" : "")>Admin</option>
                                                <option value="2" @(currentRole == "Doctor" ? "selected" : "")>Doctor</option>
                                                <option value="3" @(currentRole == "Patient" ? "selected" : "")>Patient</option>
                                            </select>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="@Url.Action("AssignRole", "AdminUser", new { area = "Admin", id = user.UserId })" 
                                                   class="btn btn-outline-primary" title="Assign Roles & Doctor">
                                                    <i class="feather-shield"></i>
                                                </a>
                                                <a href="@Url.Action("Details", "AdminUser", new { area = "Admin", id = user.UserId })" 
                                                   class="btn btn-outline-info" title="View Details">
                                                    <i class="feather-eye"></i>
                                                </a>
                                                <button type="button" class="btn btn-outline-danger" 
                                                        onclick="deleteUser(@user.UserId, '@user.FirstName @user.LastName')" title="Delete">
                                                    <i class="feather-trash-2"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-info">
                        <i class="feather-info me-2"></i>
                        No users found in the system.
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Role Legend -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title mb-3">Role Permissions</h6>
                <div class="d-flex flex-wrap gap-4">
                    <div>
                        <span class="badge bg-danger me-2">Admin</span>
                        <small class="text-muted">Full system access, user management</small>
                    </div>
                    <div>
                        <span class="badge bg-primary me-2">Doctor</span>
                        <small class="text-muted">View and manage own appointments</small>
                    </div>
                    <div>
                        <span class="badge bg-success me-2">Patient</span>
                        <small class="text-muted">Book and manage own appointments</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function quickAssignRole(userId, roleId) {
            if (!roleId) return;

            var roleName = roleId == "1" ? "Admin" : roleId == "2" ? "Doctor" : "Patient";

            // If Doctor role is selected, warn that they need to assign doctor profile
            if (roleId == "2") {
                Swal.fire({
                    title: 'Doctor Role Assignment',
                    text: "To assign Doctor role, please use the 'Assign Roles' button to also select which doctor this user is.",
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Go to Assign Roles',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = '@Url.Action("AssignRole", "AdminUser", new { area = "Admin" })' + '/' + userId;
                    } else {
                        // Reset dropdown
                        $('#roleSelect_' + userId).val('');
                    }
                });
                return;
            }

            Swal.fire({
                title: 'Assign Role',
                text: "Are you sure you want to change this user's role to " + roleName + "?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, Assign!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("QuickAssignRole", "AdminUser", new { area = "Admin" })',
                        type: 'POST',
                        data: { userId: userId, roleId: roleId },
                        success: function(response) {
                            if (response.success) {
                                Swal.fire({
                                    title: 'Success!',
                                    text: response.message,
                                    icon: 'success'
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire('Error!', response.message, 'error');
                            }
                        },
                        error: function() {
                            Swal.fire('Error!', 'An error occurred.', 'error');
                        }
                    });
                } else {
                    // Reset dropdown if cancelled
                    location.reload();
                }
            });
        }

        function deleteUser(userId, userName) {
            Swal.fire({
                title: 'Delete User',
                text: `Are you sure you want to delete "${userName}"? This action cannot be undone!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, Delete!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("Delete", "AdminUser", new { area = "Admin" })',
                        type: 'POST',
                        data: { id: userId },
                        success: function(response) {
                            if (response.success) {
                                Swal.fire({
                                    title: 'Deleted!',
                                    text: response.message,
                                    icon: 'success'
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire('Error!', response.message, 'error');
                            }
                        },
                        error: function() {
                            Swal.fire('Error!', 'An error occurred.', 'error');
                        }
                    });
                }
            });
        }
    </script>
}
